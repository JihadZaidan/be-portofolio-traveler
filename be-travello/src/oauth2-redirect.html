<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 Redirect</title>
</head>
<body>
    <script>
        (function() {
            'use strict';
            
            // Parse URL parameters
            var urlParams = new URLSearchParams(window.location.search);
            var code = urlParams.get('code');
            var state = urlParams.get('state');
            var error = urlParams.get('error');
            var errorDescription = urlParams.get('error_description');
            
            console.log('OAuth2 Redirect - Processing parameters:', {
                code: code ? 'RECEIVED' : 'MISSING',
                state: state,
                error: error,
                errorDescription: errorDescription
            });
            
            // Function to send message to parent window (Swagger UI)
            function sendMessageToParent(type, data) {
                try {
                    // Try to send to the specific opener first
                    if (window.opener) {
                        window.opener.postMessage({
                            type: type,
                            ...data
                        }, window.location.origin);
                        console.log('Message sent to opener:', type);
                    }
                    
                    // Also try to send to parent (for iframe scenarios)
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: type,
                            ...data
                        }, window.location.origin);
                        console.log('Message sent to parent:', type);
                    }
                } catch (err) {
                    console.error('Error sending message to parent:', err);
                }
            }
            
            // Function to close the popup/redirect
            function completeFlow(success, data) {
                if (success) {
                    sendMessageToParent('authorization_code', data);
                    
                    // Show success message briefly before closing
                    document.body.innerHTML = `
                        <div style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                            font-family: Arial, sans-serif;
                            background: #28a745;
                            color: white;
                            text-align: center;
                            margin: 0;
                        ">
                            <div>
                                <h2>✅ Authentication Successful!</h2>
                                <p>Redirecting back to Swagger UI...</p>
                            </div>
                        </div>
                    `;
                    
                    // Close after a short delay to show success message
                    setTimeout(function() {
                        window.close();
                    }, 1500);
                } else {
                    sendMessageToParent('authorization_error', data);
                    
                    // Show error message
                    document.body.innerHTML = `
                        <div style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                            font-family: Arial, sans-serif;
                            background: #dc3545;
                            color: white;
                            text-align: center;
                            margin: 0;
                        ">
                            <div>
                                <h2>❌ Authentication Failed</h2>
                                <p>${data.error || 'Unknown error'}</p>
                                <p>${data.error_description || ''}</p>
                                <p>This window will close automatically.</p>
                            </div>
                        </div>
                    `;
                    
                    // Close after longer delay for error reading
                    setTimeout(function() {
                        window.close();
                    }, 5000);
                }
            }
            
            // Main processing logic
            if (code && state) {
                // Successful authorization
                console.log('OAuth2 authorization successful');
                completeFlow(true, {
                    code: code,
                    state: state
                });
            } else if (error) {
                // Authorization error
                console.error('OAuth2 authorization error:', error);
                completeFlow(false, {
                    error: error,
                    error_description: errorDescription
                });
            } else {
                // Missing required parameters
                console.error('OAuth2 redirect: Missing required parameters');
                completeFlow(false, {
                    error: 'invalid_request',
                    error_description: 'Missing required authorization parameters (code or state)'
                });
            }
        })();
    </script>
</body>
</html>
